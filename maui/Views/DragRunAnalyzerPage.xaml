<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:skia="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             xmlns:vm="clr-namespace:OBD2Tool.ViewModels"
             x:Class="OBD2Tool.Views.DragRunAnalyzerPage"
             Title="Drag Run Analyzer">

    <Grid RowDefinitions="Auto,*,Auto" Padding="10">
        <!-- Control Panel -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto" Margin="0,0,0,10">
            <Button Grid.Column="0"
                    Text="Load Run"
                    Command="{Binding LoadRunCommand}"/>
            <Button Grid.Column="1"
                    Text="Clear Overlays"
                    Command="{Binding ClearOverlaysCommand}"
                    Margin="10,0"/>
            <Button Grid.Column="2"
                    Text="Compare Selected"
                    Command="{Binding CompareRunsCommand}"/>
        </Grid>

        <!-- Main Content Area -->
        <Grid Grid.Row="1" ColumnDefinitions="200,*">
            <!-- Loaded Runs Panel -->
            <StackLayout Grid.Column="0" Spacing="5">
                <Label Text="Loaded Runs" FontAttributes="Bold"/>
                <CollectionView ItemsSource="{Binding LoadedRuns}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid Padding="5" ColumnDefinitions="Auto,*,Auto">
                                <CheckBox Grid.Column="0" 
                                         IsChecked="{Binding IsVisible}"/>
                                <Label Grid.Column="1" 
                                       Text="{Binding Name}"
                                       VerticalOptions="Center"/>
                                <Button Grid.Column="2"
                                        Text="Ã—"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DragRunAnalyzerViewModel}}, Path=RemoveRunCommand}"
                                        CommandParameter="{Binding .}"/>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Run Parameters -->
                <Label Text="Parameters" FontAttributes="Bold" Margin="0,10,0,5"/>
                <CollectionView ItemsSource="{Binding AvailableParameters}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <CheckBox IsChecked="{Binding IsSelected}"
                                     Content="{Binding Name}"/>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </StackLayout>

            <!-- Graph Area -->
            <Grid Grid.Column="1" RowDefinitions="*,Auto">
                <skia:SKCanvasView Grid.Row="0"
                                  x:Name="GraphCanvas"
                                  PaintSurface="OnPaintSurface"/>

                <!-- Time/Distance Selector -->
                <StackLayout Grid.Row="1" Orientation="Horizontal" Spacing="10">
                    <Label Text="X-Axis:" VerticalOptions="Center"/>
                    <Picker ItemsSource="{Binding XAxisOptions}"
                            SelectedItem="{Binding SelectedXAxis}"/>
                    <Label Text="Scale:" VerticalOptions="Center"/>
                    <Slider Value="{Binding GraphScale}"
                            Minimum="0.1"
                            Maximum="2.0"
                            WidthRequest="100"/>
                </StackLayout>
            </Grid>
        </Grid>

        <!-- Analysis Panel -->
        <Grid Grid.Row="2" RowDefinitions="Auto,*" Margin="0,10,0,0">
            <Label Grid.Row="0" 
                   Text="Run Analysis" 
                   FontAttributes="Bold"/>
            <ScrollView Grid.Row="1" HeightRequest="150">
                <StackLayout Padding="10" BackgroundColor="#f0f0f0">
                    <Label Text="{Binding AnalysisText}"
                           LineBreakMode="WordWrap"/>
                </StackLayout>
            </ScrollView>
        </Grid>
    </Grid>

</ContentPage>
